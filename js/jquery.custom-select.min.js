$(function(){$.fn.CustomSelect=function(y){function G(){var e=$("<div>",{"class":a.prefix+"__dropdown__inner"}).css({position:"absolute",top:"-100px",left:"-100px",width:"50px",height:"50px"}),s=0,k=0;$("body").append(e);k=e.outerWidth();s=e.css({"overflow-y":"scroll"}).get(0).clientWidth;e.remove();return k-s}function t(){return!1}function B(a){a?$(document).bind("selectstart",t):$(document).unbind("selectstart",t)}var a=$.extend({},{prefix:"b-custom-select",modifier:"",visRows:10,search:!1,customScroll:!0,
speed:100,internalMode:!1},y||{});a.stateClasses={disabled:a.prefix+"_disabled",multiple:a.prefix+"_multiple",focus:a.prefix+"_focus",expanded:a.prefix+"_expanded",itemDisabled:"disabled",itemSelected:"selected"};this.each(function(){function e(){b.empty();q=$("option",f).length;z=$("optgroup",f).length;m=f.data("title");C="disabled"==f.attr("disabled");w="multiple"==f.attr("multiple");$("option",f).each(function(c){var d=$(this);c=$("<div>",{"class":a.prefix+"__item",title:d.text(),text:d.text()});
d.is(":selected")&&d.val()!=m&&"undefined"!=m&&(k(d.text()),c.addClass(a.stateClasses.itemSelected).siblings().removeClass(a.stateClasses.itemSelected));if(d.is(":disabled"))c.addClass(a.stateClasses.itemDisabled);else c.on("click",function(c){c.preventDefault();w?($(this).hasClass(a.stateClasses.itemSelected)?($(this).removeClass(a.stateClasses.itemSelected),d.removeAttr("selected")):($(this).addClass(a.stateClasses.itemSelected),d.attr({selected:"selected"})),k("\u0412\u044b\u0431\u0440\u0430\u043d\u043e ["+
$("."+a.stateClasses.itemSelected,b).length+"]"),f.change()):($(this).hasClass(a.stateClasses.itemSelected)||($(this).addClass(a.stateClasses.itemSelected).siblings().removeClass(a.stateClasses.itemSelected),k(d.text()),b.usekey||f.val(d.val()).change()),l.is("."+a.stateClasses.expanded)&&!b.usekey&&g.trigger("hide"),b.usekey=!1)});if(d.parent().is("optgroup")&&d.is(":first-child")){var n=d.parent();b.append($("<div>",{"class":a.prefix+"__group",title:n.attr("label"),text:n.attr("label")}))}b.append(c)});
q>a.visRows?t():D();u?v.prepend(p):v.prepend(E);C?(l.addClass(a.stateClasses.disabled),u&&p.attr("disabled","disabled"),v.unbind("click")):0<q+z&&(l.removeClass(a.stateClasses.disabled),p.removeAttr("disabled","disabled"),v.on("click",function(c){c.preventDefault();$("."+a.prefix+"__dropdown").not(g).trigger("hide");g.trigger("toggle")}));w&&(l.addClass(a.stateClasses.multiple),"undefined"==typeof m||0<$("."+a.stateClasses.itemSelected,b).length)&&(m="\u0412\u044b\u0431\u0440\u0430\u043d\u043e ["+
$("."+a.stateClasses.itemSelected,b).length+"]");k(m)}function s(c){var d=c.index();b.usekey=!0;if(!(0>d)){var n=$("."+a.stateClasses.itemSelected,b),f=$("."+a.prefix+"__item:first",b).outerHeight(!0),l=g.height(),e=-1,d=c.index(),n=n.index(),k=c.position().top;d<n&&k<=f?e=h.scrollTop()+k-parseInt(b.css("padding-top")):d>n&&f>=l-k&&(e=h.scrollTop()+k+f-l+parseInt(b.css("padding-bottom")));c.click();0<=e&&h.scrollTop(e)}}function k(a){u?p.val(a):E.text(a)}function t(){h.css({"overflow-y":"scroll"});
if(a.customScroll){h.css({width:x+H+"px"});var c=!1,d=0;b.after(A);h.on("scroll",function(){r.css({top:F()+"px"})});r.on("mousedown",function(a){c=!0;B(1);d=a.clientY-F()});$(document).on("mouseup blur",function(a){c=!1;B()}).on("mousemove",function(a){c&&(a=(a.clientY-d)*(b.outerHeight(!0)-h.height())/(h.height()-r.outerHeight(!0)),h.scrollTop(a))})}}function D(){h.css({width:"auto","overflow-y":"visible"});b.css({"margin-right":0});A.remove()}function F(){return h.scrollTop()/(b.outerHeight(!0)-
h.height())*(h.height()-r.outerHeight(!0))}function y(c){var d,f=0,h=c.replace(RegExp("(\\/|\\.|\\*|\\+|\\?|\\||\\(|\\)|\\[|\\]|\\{|\\}|\\\\|\\^|\\$)","g"),"\\$1");c=new RegExp("^.*?"+h+".*$","i");$("."+a.prefix+"__item",b).each(function(){d=$(this);c.test(d.text())?(d.show(),f++):d.hide()});f>a.visRows?t():D();0<f?($("."+a.prefix+"__item_notfound",b).remove(),g.trigger("show")):$("."+a.prefix+"__item_notfound",b).length||b.append($("<div>",{"class":a.prefix+"__item "+a.prefix+"__item_notfound",text:"\u041d\u0438\u0447\u0435\u0433\u043e \u043d\u0435 \u043d\u0430\u0439\u0434\u0435\u043d\u043e!"}));
g.trigger("show")}var f=$(this),m=f.data("title"),C="disabled"==f.attr("disabled"),w="multiple"==f.attr("multiple"),u=w?!1:a.search,z=0,q=0,x=f.outerWidth(),H=G(),v=$("<div>",{"class":a.prefix+"__title",html:'<i class="'+a.prefix+'__title__icon"></i>'}),E=$("<div>",{"class":a.prefix+"__title__text"}),p=$("<input>",{type:"text","class":a.prefix+"__title__input"}).css({width:x-$("."+a.prefix+"__title__icon").outerWidth()}),l=$("<div>",{"class":a.prefix+("string"==typeof a.modifier&&""!=a.modifier?" "+
a.prefix+"_"+a.modifier:""),html:v}).css({width:x}),b=$("<div>",{"class":a.prefix+"__list"}),g=$("<div>",{"class":a.prefix+"__dropdown"+("string"==typeof a.modifier&&""!=a.modifier?" "+a.prefix+"__dropdown_"+a.modifier:""),html:b}).css({display:"none",position:"absolute",width:x,zIndex:999}),h=$("<div>",{"class":a.prefix+"__dropdown__inner"}).css({height:"100%"}),r=$("<div>",{"class":a.prefix+"__scrollbar"}),A=$("<div>",{"class":a.prefix+"__wrap-scrollbar",html:r});b.usekey=!1;b.wrap(h);h=$("."+a.prefix+
"__dropdown__inner",g);e();f.css({position:"absolute",opacity:.1,width:0,height:0}).after(l);g.bind("show",function(){if(g.is(":animated"))return!1;u||f.focus();$("body").append(g);l.addClass(a.stateClasses.expanded).addClass(a.stateClasses.focus);var c=0,d=q+z,e=l.offset(),k=e.left,m=e.top+l.outerHeight(),e=b.outerHeight()-b.height();a.internalMode?(m="100%",k=0,l.append(g)):$("body").append(g);g.css({left:k,top:m,height:0}).show();q>a.visRows&&(d=a.visRows,a.customScroll&&b.css({"margin-right":A.outerWidth(!0)}));
for(k=0;k<d;k++)e+=b.find("div:visible").eq(k).outerHeight(!0);g.animate({height:e},a.speed,function(){q>a.visRows&&(r.height(h.height()*h.height()/b.outerHeight()),c=$("."+a.stateClasses.itemSelected,b).index()>a.visRows?$("."+a.stateClasses.itemSelected,b).position().top-parseInt(b.css("padding-top")):0,h.scrollTop(c),0==c&&h.trigger("scroll"))})}).bind("hide",function(){if(g.is(":animated"))return!1;g.slideUp(a.speed,function(){l.removeClass(a.stateClasses.expanded);g.detach();u&&""==p.val()&&
($("."+a.prefix+"__item_notfound",b).remove(),b.find("div").show())})}).bind("toggle",function(){l.hasClass(a.stateClasses.expanded)?g.trigger("hide"):g.trigger("show")});f.on("focus",function(c){l.addClass(a.stateClasses.focus)}).on("blur",function(c){l.removeClass(a.stateClasses.focus)}).on("keydown",function(c){switch(c.keyCode){case 38:case 37:s($("."+a.stateClasses.itemSelected,b).prevAll("."+a.prefix+"__item:not(.disabled):first"));break;case 40:case 39:s($("."+a.stateClasses.itemSelected,b).nextAll("."+
a.prefix+"__item:not(.disabled):first"));break;case 13:$("."+a.stateClasses.itemSelected,b).click();c.preventDefault();break;case 32:l.is("."+a.stateClasses.expanded)||g.trigger("show"),c.preventDefault()}}).bind("update",function(a){g.trigger("hide");e()});p.on("focus",function(){$(this).select()}).on("keyup",function(a){switch(a.keyCode){case 27:g.trigger("hide");break;case 38,40:console.log(a);f.trigger(a);break;default:clearTimeout($.data(this,"timer")),a=setTimeout(function(){y(p.val())},500),
$(this).data("timer",a)}}).on("blur",function(){""==$(this).val()&&k(m)})});$(document).on("keydown",function(e){switch(e.keyCode){case 27:$("."+a.prefix+"__dropdown").trigger("hide")}}).on("click",function(e){$(e.target).parents().filter("."+a.prefix+"__dropdown").length||$(e.target).is("option")||$("."+a.prefix+"__dropdown").trigger("hide")})}});
